name: Build and Deploy to Dev

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'db/**'
      - 'web/**'
      - 'docker/**'
      - '.github/workflows/build-deploy-dev.yml'

  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  GITOPS_REPO: bcgov-c/tenant-gitops-a94b15
  GITOPS_BRANCH: develop
  IMAGE_API: ghcr.io/bcgov-c/jag-probate-api
  IMAGE_WEB: ghcr.io/bcgov-c/jag-probate-web

jobs:
  build-and-push-images:
    name: Build and Push Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
      web-changed: ${{ steps.filter.outputs.web }}
      image-tag: ${{ steps.meta.outputs.tag }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
              - 'db/**'
              - 'docker/api/**'
            web:
              - 'web/**'
              - 'docker/web/**'

      - name: Set image tag
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag: ${SHORT_SHA}"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        if: steps.filter.outputs.api == 'true'
        run: |
          docker build \
            -f docker/api/Dockerfile \
            -t ${{ env.IMAGE_API }}:${{ steps.meta.outputs.tag }} \
            -t ${{ env.IMAGE_API }}:latest \
            .
          docker push ${{ env.IMAGE_API }}:${{ steps.meta.outputs.tag }}
          docker push ${{ env.IMAGE_API }}:latest
          echo "API image pushed: ${{ env.IMAGE_API }}:${{ steps.meta.outputs.tag }}"

      - name: Build and push Web image
        if: steps.filter.outputs.web == 'true'
        run: |
          docker build \
            -f docker/web/Dockerfile \
            -t ${{ env.IMAGE_WEB }}:${{ steps.meta.outputs.tag }} \
            -t ${{ env.IMAGE_WEB }}:latest \
            .
          docker push ${{ env.IMAGE_WEB }}:${{ steps.meta.outputs.tag }}
          docker push ${{ env.IMAGE_WEB }}:latest
          echo "Web image pushed: ${{ env.IMAGE_WEB }}:${{ steps.meta.outputs.tag }}"

  update-gitops:
    name: Update GitOps Repository
    needs: build-and-push-images
    if: needs.build-and-push-images.outputs.api-changed == 'true' || needs.build-and-push-images.outputs.web-changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          ref: ${{ env.GITOPS_BRANCH }}
          token: ${{ secrets.GITOPS_DEPLOY_TOKEN }}
          path: gitops

      - name: Update API image tag
        if: needs.build-and-push-images.outputs.api-changed == 'true'
        working-directory: gitops/services/probate
        run: |
          TAG="${{ needs.build-and-push-images.outputs.image-tag }}"
          
          # Update kustomization.yaml with new API image tag
          sed -i "/name: jag-probate-api/{n;s|newTag:.*|newTag: ${TAG}|}" kustomization.yaml
          
          echo "Updated API image tag to: ${TAG}"
          cat kustomization.yaml

      - name: Update Web image tag
        if: needs.build-and-push-images.outputs.web-changed == 'true'
        working-directory: gitops/services/probate
        run: |
          TAG="${{ needs.build-and-push-images.outputs.image-tag }}"
          
          # Update kustomization.yaml with new Web image tag
          sed -i "/name: jag-probate-web/{n;s|newTag:.*|newTag: ${TAG}|}" kustomization.yaml
          
          echo "Updated Web image tag to: ${TAG}"
          cat kustomization.yaml

      - name: Commit and push changes
        working-directory: gitops
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add services/probate/kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="Deploy probate to dev - SHA: ${{ needs.build-and-push-images.outputs.image-tag }}"
            
            if [[ "${{ needs.build-and-push-images.outputs.api-changed }}" == "true" ]] && [[ "${{ needs.build-and-push-images.outputs.web-changed }}" == "true" ]]; then
              COMMIT_MSG="${COMMIT_MSG}\n\nUpdated: API + Web"
            elif [[ "${{ needs.build-and-push-images.outputs.api-changed }}" == "true" ]]; then
              COMMIT_MSG="${COMMIT_MSG}\n\nUpdated: API"
            else
              COMMIT_MSG="${COMMIT_MSG}\n\nUpdated: Web"
            fi
            
            git commit -m "${COMMIT_MSG}"
            git push origin ${{ env.GITOPS_BRANCH }}
            
            echo "GitOps repository updated successfully!"
            echo "ArgoCD will sync the changes automatically"
          fi

      - name: Summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development (a94b15-dev)" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.build-and-push-images.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-and-push-images.outputs.api-changed }}" == "true" ]]; then
            echo "API image updated" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-and-push-images.outputs.web-changed }}" == "true" ]]; then
            echo "Web image updated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. GitOps repo updated in \`${{ env.GITOPS_BRANCH }}\` branch" >> $GITHUB_STEP_SUMMARY
          echo "2. ArgoCD will detect changes and sync automatically" >> $GITHUB_STEP_SUMMARY
          echo "3. Rolling update will be performed in OpenShift" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View GitOps Repo](https://github.com/${{ env.GITOPS_REPO }}/tree/${{ env.GITOPS_BRANCH }})" >> $GITHUB_STEP_SUMMARY
